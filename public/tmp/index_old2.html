<html>
<head>
</head>
<body id="body">
    <style>
        html,
        body {
            position: relative;
            height: 100vh;
            padding: 0px;
            margin: 0px;
        }

        #player {
            /* height: 100px;
            width: 100px; */
            background-color: red;
            position: absolute;
            /* bottom: 500px; */
        }

        #floor {
            height: 200px;
            width: 100vw;
            background-color: brown;
            bottom: 0px;
            position: absolute;
        }

        .platform {
            /* height: 100px;
            width: 100px; */
            /* bottom: 0px; */
            position: absolute;
            background-color: brown;
            /* left: 250px; */
        }

        #platform {
            /* bottom: 0px;
            left: 250px; */
        }
        #platform2 {
            bottom: 100px;
            left: 500px;
        }
    </style>
    <!-- <div id="player"></div> -->
    <!-- <div id="platform" class="platform"></div>
    <div id="platform2" class="platform"></div> -->
    <!-- <div id="floor" class="ground"></div> -->

    <script type="text/javascript">
        const fps = 60;
        const ms = 1000 / fps;

        const speed = 4;
        const gravity = 0.5;

        class Component {
            constructor(id, x = 0, y = 0, width, height, className = null, kinetic = true) {
                this.id = id;
                this.x = x;
                this.y = y;
                this.vx = 0;
                this.vy = 0;
                this.oldx = this.x;
                this.oldy = this.y;
                let div = document.createElement('div');
                this.elem = div;
                div.id = id;
                if (className != null) {
                    div.classList.add(className);
                }
                div.style.width = width;
                div.style.height = height;
                if (kinetic) {
                    div.style.left = x;
                    div.style.top = y;
                }
                document.getElementById("body").appendChild(div);
                this.height = height;
                this.width = width;
                this.anim = this.elem.animate(null, { duration: ms });
            }

            animate() {
                let keyframes = [
                    { transform: 'translate(' + this.oldx + 'px, ' + this.oldy + 'px)' },
                    { transform: 'translate(' + this.x + 'px, ' + this.y + 'px)' },
                ]

                this.anim.effect.setKeyframes(keyframes)
                this.anim.play();
            }

        }

        
        class Player extends Component {
            constructor(id, x, y, width, height, className, kinetic) {
                super(id, x, y, width, height, className, kinetic);
                this.jumping = false;
                this.onPlatform = false;
            }
            

            tick(commands) {
                this.oldx = this.x;
                this.oldy = this.y;
                let windowBottom = window.innerHeight - this.height;
                let windowRight = window.innerWidth;
                var intersectingY = false;

                if (commands.left) {
                    this.x -= speed;
                }
                if (commands.right) {
                    this.x += speed;
                }
                if (commands.up && !this.jumping) {
                    this.vy = -15;
                }


                this.vy += gravity;
                this.y += this.vy;

                Platforms.forEach(p => {
                    if (rectIntersect(this.x, this.y, this.width, this.height, p.x, p.y, p.width, p.height)) { //TODO: Still needed? 🤷‍♂️

                        if (this.x + this.width > p.x && this.x < p.x + p.width &&
                            this.oldy + this.height > p.y && this.oldy < p.y + p.height) { //https://happycoding.io/tutorials/processing/collision-detection#collision-detection-with-moving-objects
                            // this.x = this.oldx;
                            if (this.oldx > this.x) {
                                this.x = p.x + this.width;
                            } else {
                                this.x = p.x - this.width;
                            }
                            console.log("intersect X");
                        }

                        if (this.oldx + this.width > p.x && this.oldx < p.x + p.width &&
                            this.y + this.height > p.y && this.y < p.y + p.height) {
                            if (this.vy > 0) {
                                this.y = p.y - this.height;
                                if (this.onPlatform == false) {
                                    console.log("intersecting w platform top")
                                    this.onPlatform = true;
                                }

                            } else {
                                this.y = p.y + this.height;
                            }
                            this.vy = 0;
                            console.log("intersect Y");
                            intersectingY = true;
                            
                        }
                    }
                });

                if (this.x < 0 ) { // Wall/Windows Collision || this.x + this.width > windowRight
                    this.x = this.oldx;
                }

                this.jumping = (this.y <= windowBottom && intersectingY == false);
                if (this.y > windowBottom) { // Ground/Window Collision
                    this.vy = 0;
                    this.y = windowBottom;
                }
                
                if (this.jumping && this.vy < 0 && this.onPlatform) { // Jumping off platform FIXME: falling off platform does not onPlatform = false
                    this.onPlatform = false;
                    Platforms.push(
                        new Platform("platorm_"+Platforms.length + 1, this.x + 250, this.y, 100, 100, 'platform')
                    );
                }

                if (this.x > window.innerWidth / 2) { // Camera scrolling
                    window.scrollTo(this.x - (window.innerWidth / 2), 0);
                }

                this.animate();
            }
        }

        function rectIntersect(x1, y1, w1, h1, x2, y2, w2, h2) {
            if (x2 > w1 + x1 || x1 > w2 + x2 || y2 > h1 + y1 || y1 > h2 + y2) {
                return false;
            }
            return true;
        }

        class Platform extends Component {
            constructor(id, x, y, width, height, className, kinetic) {
                super(id, x, y, width, height, className, kinetic);
            }
        }

        const player = new Player('player', 10, 900, 100, 100, null, false);

        const Platforms = [
            new Platform('platform1', 200, window.innerHeight - 200, 100, 100, 'platform'),
        ];

        player.anim.onfinish = () => {
            //Player Movement
            player.tick(commands);
        };

        const commands = {
            left: false,
            right: false,
            up: false,
        };

        window.addEventListener('down', onkeydown, false);
        window.addEventListener('up', onkeyup, false);

        onkeydown = onkeyup = (e) => {
            let key = e.code;
            let keydown = (e.type === 'keydown');
            let keyup = (e.type === 'keyup');
            if (key === 'KeyA') commands.left = keydown ? true : keyup ? false : commands.left;
            if (key === 'KeyD') commands.right = keydown ? true : keyup ? false : commands.right;
            if (key === 'KeyW') commands.up = keydown ? true : keyup ? false : commands.up;
        };
    </script>
</body>

</html>