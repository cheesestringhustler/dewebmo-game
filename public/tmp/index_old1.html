<html>

<head>

</head>

<body>
    <style>
        html,
        body {
            height: 100vh;
            padding: 0px;
            margin: 0px;
        }

        #player {
            height: 100px;
            width: 100px;
            background-color: red;
            position: absolute;
            /* bottom: 500px; */
        }

        #floor {
            height: 200px;
            width: 100vw;
            background-color: brown;
            bottom: 0px;
            position: absolute;
        }

        .platform {
            height: 100px;
            width: 100px;
            /* bottom: 0px; */
            position: absolute;
            background-color: brown;
            /* left: 250px; */
        }

        #platform {
            bottom: 0px;
            left: 250px;
        }
        #platform2 {
            bottom: 100px;
            left: 500px;
        }
    </style>
    <div id="player"></div>
    <div id="platform" class="platform"></div>
    <div id="platform2" class="platform"></div>
    <!-- <div id="floor" class="ground"></div> -->

    <script type="text/javascript">
        const fps = 60;
        const ms = 1000 / fps;

        const speed = 4;
        const gravity = 0.5;

        class Component {
            constructor(id, x = 0, y = 0) {
                this.id = id;
                this.x = x;
                this.y = y;
                this.vx = 0;
                this.vy = 0;
                this.oldx = this.x;
                this.oldy = this.y;
                this.elem = document.getElementById(this.id);
                this.height = this.elem.getBoundingClientRect().height;
                this.width = this.elem.getBoundingClientRect().width;
                this.anim = this.elem.animate(null, { duration: ms });
            }

            animate() {
                let keyframes = [
                    { transform: 'translate(' + this.oldx + 'px, ' + this.oldy + 'px)' },
                    { transform: 'translate(' + this.x + 'px, ' + this.y + 'px)' },
                ]

                this.anim.effect.setKeyframes(keyframes)
                this.anim.play();
            }

        }

        class Player extends Component {
            constructor(id, x, y) {
                super(id, x, y);
                this.jumping = false;
            }

            tick(commands) {
                this.oldx = this.x;
                this.oldy = this.y;
                let windowBottom = window.innerHeight - this.height;
                let windowRight = window.innerWidth;
                var intersectingY = false;

                if (commands.left) {
                    this.x -= speed;
                }
                if (commands.right) {
                    this.x += speed;
                }
                if (commands.up && !this.jumping) {
                    this.vy = -15;
                }


                this.vy += gravity;
                this.y += this.vy;

                Platforms.forEach(p => {
                    if (rectIntersect(this.x, this.y, this.width, this.height, p.x, p.y, p.width, p.height)) { //TODO: Still needed? 🤷‍♂️

                        if (this.x + this.width > p.x && this.x < p.x + p.width &&
                            this.oldy + this.height > p.y && this.oldy < p.y + p.height) { //https://happycoding.io/tutorials/processing/collision-detection#collision-detection-with-moving-objects
                            this.x = this.oldx;
                            console.log("intersect X");
                        }

                        if (this.oldx + this.width > p.x && this.oldx < p.x + p.width &&
                            this.y + this.height > p.y && this.y < p.y + p.height) {
                            this.y = this.oldy;
                            this.vy = 0;
                            console.log("intersect Y");
                            intersectingY = true;
                        }
                    }
                });

                if (this.x < 0 || this.x + this.width > windowRight) { // Wall/Windows Collision
                    this.x = this.oldx;
                }

                this.jumping = (this.y <= windowBottom && intersectingY == false);
                if (this.y > windowBottom) { // Ground/Window Collision
                    this.vy = 0;
                    this.y = windowBottom;
                }

                this.animate();
            }
        }

        function rectIntersect(x1, y1, w1, h1, x2, y2, w2, h2) {
            if (x2 > w1 + x1 || x1 > w2 + x2 || y2 > h1 + y1 || y1 > h2 + y2) {
                return false;
            }
            return true;
        }

        class Platform extends Component {
            constructor(id, x, y) {
                super(id, x, y);
                if (this.x === 0) {
                    this.x = this.elem.getBoundingClientRect().x;
                }
                if (this.y === 0) {
                    this.y = this.elem.getBoundingClientRect().y;
                }

                // let node = document.createElement("div");
                // node.id = id;
                // node.style.left = x;
                // node.style.bottom = y;
                // document.body.appendChild(node);
            }
        }

        const player = new Player('player', 10, 1000);
        const Platforms = [
            new Platform('platform', 0, 0),
            new Platform('platform2', 100, 100),
        ];

        player.anim.onfinish = () => {

            //Player Movement
            player.tick(commands);

        };

        const commands = {
            left: false,
            right: false,
            up: false,
        };

        window.addEventListener('down', onkeydown, false);
        window.addEventListener('up', onkeyup, false);

        onkeydown = onkeyup = (e) => {
            let key = e.code;
            let keydown = (e.type === 'keydown');
            let keyup = (e.type === 'keyup');
            if (key === 'KeyA') commands.left = keydown ? true : keyup ? false : commands.left;
            if (key === 'KeyD') commands.right = keydown ? true : keyup ? false : commands.right;
            if (key === 'KeyW') commands.up = keydown ? true : keyup ? false : commands.up;
        };
    </script>
</body>

</html>